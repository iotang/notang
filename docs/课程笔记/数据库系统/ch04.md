# 第 4 章：进阶的 SQL 语言

## 自定义数据类型和域

```sql
create type Credit as numeric(12, 2);
create domain Money as numeric(12, 2) not null;
create table account (
    account_name varchar(20),
    credit Credit,
    balance Money);
```

## 巨型文件

- blob：二进制的大文件。
- clob：文本式的大文件。

当有查询涉及它们的时候，返回的会是一个指向它们的指针。

## 完整性约束

- not null
- primary key (属性名)
- foreign key (属性名) references 表名
- unique
- check(P)

## SQL 的级联

```sql
foreign key (teammate) references pokedex
[on delete cascade] [on update cascade] ...
```

### 断言 Assertions

```sql
create assertion assertion_name
  check ...;
```

### 触发器 Triggers

```sql
create trigger hp_check after insert on teammate
  referencing new row as nrow
  if (nrow.hp <= 0) begin
    rollback
  end;

```

## 授权 Authorization

```sql
grant <privilege list>
on <relation name or view name>
to <user list>;
```

`<user list>` 里面可以放一个用户 ID、一个角色（role）或者 `public`（所有人）。

```sql
create role instructor;
grant select on teammate to instructor; -- instructor 有看 teammate 的权限
create role dean;
grant dean to Arceus; -- 阿尔宙斯现在是院长
grant instructor to dean; -- 院长现在有 instructor 的权限
```

```sql
revoke select
on teammate
from instructor [restrict | cascade]; -- restrict：仅限这个角色；cascade：连带授权关系
```

`revoke all`：收回所有权限。

`... from public`：收回所有人通过 `public` 拿到的权限。通过其他指明拿到的权限还会在。

## 审计跟踪 Audit Trails

```sql
audit table -- view, role, index, ...
by Hoopa
by access
whenever successful;
```

审计用户胡帕所有的成功执行的有关 table 的语句（create table、drop table、alter table 等）。

```sql
audit update, delete -- update, select, grant, ...
by Hoopa
on character_list;
```

审计胡帕对 character_list 表的 update 和 delete 操作。比如会发现这个：

```sql
update character_list
set alive = true
where name = '拉帝欧斯'
  and native_place = '奥多马雷';
```
